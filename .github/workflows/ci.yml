name: CI/CD to Self-Hosted Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      frontend_port:
        description: 'Frontend port (default: 8010)'
        required: false
        default: '8010'

jobs:
  build-and-deploy:
    runs-on: [self-hosted]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Build project
      run: pnpm run build
      
    - name: Stop existing server
      run: |
        pm2 delete hookcode-test || true
        
    - name: Start preview server with PM2
      run: |
        PORT=${{ github.event.inputs.frontend_port || '8010' }}
        echo "Starting preview server on port $PORT with PM2"
        PORT=$PORT pm2 start "pnpm run preview -- --port $PORT --host 0.0.0.0" --name hookcode-test
        pm2 save
        sleep 5
        
    - name: Health check
      run: |
        PORT=${{ github.event.inputs.frontend_port || '8010' }}
        curl -f http://localhost:$PORT || exit 1
        echo "âœ… Server is running successfully on port $PORT"
        
    - name: Display server info
      run: |
        PORT=${{ github.event.inputs.frontend_port || '8010' }}
        pm2 list
        echo "Server Port: $PORT"
        echo "Server URL: http://localhost:$PORT"
        echo "View logs: pm2 logs hookcode-test"
